WITH msc_sitegroups AS (
    SELECT sg.SiteGroupId
    FROM app.SiteGroups sg
    WHERE sg.Name LIKE 'MSC-%'
       OR sg.Name LIKE '%-MSC-%'
       OR sg.Name LIKE '%-MSC'
       OR sg.Name LIKE '%Region%MSC%'
)
SELECT DISTINCT
    u.UserId,
    u.LoginName,
    u.FullName,
    u.Email
FROM app.Users u
WHERE EXISTS (
    SELECT 1
    FROM app.UserSiteGroups usg
    JOIN msc_sitegroups m ON m.SiteGroupId = usg.SiteGroupId
    WHERE usg.UserId = u.UserId
)
AND NOT EXISTS (
    SELECT 1
    FROM app.UserSiteGroups usg
    WHERE usg.UserId = u.UserId
      AND usg.SiteGroupId NOT IN (SELECT SiteGroupId FROM msc_sitegroups)
);
