WITH RECURSIVE loc_tree AS (
    -- Roots (Base locations)
    SELECT
        t.location_uuid,
        t.parent_loc_uuid,
        t.location_code,
        t.element_type,
        t.location_code::text AS base_code
    FROM psc_site_code_info t
    WHERE t.element_type = 'BaseLocation'
       OR t.parent_loc_uuid IS NULL

    UNION ALL

    -- Children: propagate base_code to all descendants
    SELECT
        c.location_uuid,
        c.parent_loc_uuid,
        c.location_code,
        c.element_type,
        p.base_code
    FROM psc_site_code_info c
    JOIN loc_tree p
      ON c.parent_loc_uuid = p.location_uuid
)
SELECT
    p.id,
    p.site_code_syny,
    p.site_code,
    p.site_code_vzb_6_char,
    p.site_name,
    p.site_code_vz_cmpny,
    p.is_active,
    p.site_group,
    p.location_uuid,
    p.location_code,
    p.location_code_type,
    p.element_type,
    p.parent_loc_uuid,
    p.dctrack_location_id,
    p.sensitive_location,
    p.managing_org,
    p.psc_workflow,

    CASE
        WHEN p.element_type = 'BaseLocation'
             OR p.parent_loc_uuid IS NULL
        THEN lt.base_code
        ELSE lt.base_code || ' > ' || p.location_code
    END AS path

FROM psc_site_code_info p
JOIN loc_tree lt
  ON lt.location_uuid = p.location_uuid

WHERE p.element_type IN ('BaseLocation', 'Floor')   -- only Base + Floor

ORDER BY lt.base_code, path;
